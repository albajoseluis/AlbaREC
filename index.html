<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clima Detallado de Albacete</title>
    <!-- Carga de Tailwind CSS para un dise√±o responsivo y r√°pido -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el fondo verde croma */
        body {
            background-color: #00FF00; /* Verde croma */
            font-family: 'Inter', sans-serif; /* Fuente Inter */
        }
        /* Ocultar el spinner de carga por defecto */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: none; /* Oculto por defecto */
        }
        @keyframes spin {
            0% { transform: translateX(100%); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor principal para la sensaci√≥n de 16:9 y el dise√±o -->
    <div class="flex flex-col lg:flex-row w-full max-w-screen-xl h-[calc(100vh-2rem)] bg-white bg-opacity-90 rounded-lg shadow-xl overflow-hidden">

        <!-- Contenido de la izquierda (aproximadamente 3/4 del ancho) -->
        <div class="lg:w-3/4 p-8 flex flex-col items-center justify-center text-center">
            <div class="flex-grow flex items-center justify-center">
                <p class="text-2xl text-gray-500">Bienvenido a la informaci√≥n del clima de Albacete</p>
            </div>
        </div>

        <!-- Contenido de la derecha (aproximadamente 1/4 del ancho): Datos consolidados -->
        <div class="lg:w-1/4 p-6 flex flex-col justify-start bg-gray-50 bg-opacity-90">

            <!-- Cuadro consolidado de informaci√≥n del clima -->
            <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center justify-center h-full">

                <!-- Albacete (Incluye hora actual, temp actual, icono, descripci√≥n y min/max temp) -->
                <div class="text-center w-full mb-4">
                    <h2 class="text-3xl lg:text-4xl font-extrabold text-gray-800 mb-2">Albacete</h2>
                    
                    <!-- Hora actual -->
                    <p id="current-time" class="text-2xl font-bold text-gray-900 mb-4 animate-pulse">Cargando...</p>

                    <div class="flex items-center justify-center mb-2">
                        <span id="current-weather-icon" class="text-5xl mr-2">‚ùì</span> <!-- Icono del tiempo -->
                        <p id="current-temperature-right" class="text-4xl font-bold text-red-500">--¬∞C</p> <!-- Temperatura actual -->
                    </div>
                    <p id="current-weather-description" class="text-lg text-gray-600 mb-4"></p> <!-- Descripci√≥n del tiempo -->

                    <!-- M√≠n. / M√°x. Temp. -->
                    <div class="text-lg text-gray-800">
                        M√≠nima: <span id="min-temp" class="font-bold text-green-700">--¬∞C</span><br>
                        M√°xima: <span id="max-temp" class="font-bold text-red-700">--¬∞C</span>
                    </div>
                </div>

                <!-- Humedad -->
                <div class="text-center w-full border-t pt-4 border-gray-200 mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">Humedad</h2>
                    <p id="humidity" class="text-3xl font-bold text-blue-700">--%</p>
                </div>

                <!-- Viento y Racha M√°xima -->
                <div class="text-center w-full border-t pt-4 border-gray-200 mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">Viento</h2>
                    <p id="wind-speed" class="text-3xl font-bold text-purple-700 mb-2">-- km/h</p>
                    <p class="text-lg text-gray-800">Racha m√°x: <span id="gust-speed" class="font-bold text-purple-700">-- km/h</span></p>
                </div>

                <!-- Precipitaci√≥n -->
                <div class="text-center w-full border-t pt-4 border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">Precipitaci√≥n</h2>
                    <p id="precipitation" class="text-3xl font-bold text-teal-700">-- mm</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Spinner de carga y mensaje de error (fuera del contenedor principal para que siempre sean visibles) -->
    <div id="loading-spinner" class="loading-spinner fixed bottom-8 right-8"></div>
    <p id="error-message" class="text-red-600 fixed bottom-4 left-1/2 -translate-x-1/2 bg-white p-2 rounded-lg shadow-lg hidden">Error al cargar los datos del clima. Por favor, verifica tu clave API de AEMET y la conexi√≥n a internet.</p>

    <script>
        // Funciones auxiliares para audio PCM (no directamente relacionadas con el clima)
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1; // Mono
            const bytesPerSample = 2; // 16-bit PCM
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;

            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(view, 8, 'WAVE');

            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bytesPerSample * 8, true);

            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);

            const combined = new Uint8Array(wavHeader.byteLength + pcmData.byteLength);
            combined.set(new Uint8Array(wavHeader), 0);
            combined.set(new Uint8Array(pcmData.buffer), wavHeader.byteLength);

            return new Blob([combined], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Referencias a los elementos del DOM
        const currentTimeElement = document.getElementById('current-time');
        const currentTemperatureRightElement = document.getElementById('current-temperature-right');
        const currentWeatherIconElement = document.getElementById('current-weather-icon');
        const currentWeatherDescriptionElement = document.getElementById('current-weather-description');
        const minTempElement = document.getElementById('min-temp');
        const maxTempElement = document.getElementById('max-temp');
        const humidityElement = document.getElementById('humidity');
        const windSpeedElement = document.getElementById('wind-speed');
        const gustSpeedElement = document.getElementById('gust-speed');
        const precipitationElement = document.getElementById('precipitation');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageElement = document.getElementById('error-message');


        // Configuraci√≥n de la API de AEMET (revertida)
        const AEMET_API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJlbG1pcmFkb3JkZWFsYmFjZXRlQGdtYWlsLmNvbSIsImp0aSI6IjVkOWEwODRkLWIyMGYtNDVhNy1iNGIwLTNkYjExNjAwYjhlZCIsImlzcyI6IkFFTUVUIiwiaWF0IjoxNzU0MDg1MTU3LCJ1c2VySWQiOiI1ZDlhMDg0ZC1iMjBmLTQ1YTctYjRiMC0zZGIxMTYwMGI4ZWQiLCJyb2xlIjoiIn0.-6ok6kl3fvxe_OZt8Unq_WDZ7OjXBHLJGwx-O8FUXuM';
        const ALBACETE_STATION_ID = '8178D'; // ID de la estaci√≥n de Albacete (Observatorio)
        const ALBACETE_MUNICIPALITY_CODE = '02003'; // C√≥digo de municipio de Albacete

        const AEMET_OBSERVATION_URL = `https://opendata.aemet.es/opendata/api/observacion/convencional/datos/estacion/${ALBACETE_STATION_ID}?api_key=${AEMET_API_KEY}`;
        const AEMET_FORECAST_URL = `https://opendata.aemet.es/opendata/api/prediccion/especifica/municipio/diaria/${ALBACETE_MUNICIPALITY_CODE}?api_key=${AEMET_API_KEY}`;

        /**
         * Actualiza la hora actual en Albacete.
         * Utiliza Intl.DateTimeFormat para manejar la zona horaria.
         */
        function updateTime() {
            const now = new Date();
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'Europe/Madrid'
            };
            const albaceteTime = new Intl.DateTimeFormat('es-ES', options).format(now);
            currentTimeElement.textContent = albaceteTime;
        }

        /**
         * Mapea la descripci√≥n del estado del cielo de AEMET a un icono emoji y una descripci√≥n amigable.
         * @param {string} aemetDescription - Descripci√≥n del estado del cielo de la API de AEMET.
         * @returns {{icon: string, description: string}} Objeto con el icono emoji y la descripci√≥n.
         */
        function getWeatherIconAndDescription(aemetDescription) {
            let icon = '‚ùì'; // Icono por defecto (signo de interrogaci√≥n)
            let description = aemetDescription || '';

            if (aemetDescription) {
                const lowerDescription = aemetDescription.toLowerCase();
                const now = new Date();
                const hours = now.getHours();
                const isDay = hours >= 7 && hours < 21;

                if (lowerDescription.includes('despejado')) {
                    icon = isDay ? '‚òÄÔ∏è' : 'üåô';
                    description = 'Despejado';
                } else if (lowerDescription.includes('poco nuboso') || lowerDescription.includes('intervalos nubosos')) {
                    icon = isDay ? '‚õÖ' : '‚òÅÔ∏è';
                    description = 'Poco Nuboso';
                } else if (lowerDescription.includes('nuboso') || lowerDescription.includes('cubierto') || lowerDescription.includes('muy nuboso')) {
                    icon = '‚òÅÔ∏è';
                    description = 'Nublado';
                } else if (lowerDescription.includes('lluvia') || lowerDescription.includes('chubascos') || lowerDescription.includes('llovizna')) {
                    icon = 'üåßÔ∏è';
                    description = 'Lluvioso';
                } else if (lowerDescription.includes('nieve')) {
                    icon = 'üå®Ô∏è';
                    description = 'Nevando';
                } else if (lowerDescription.includes('niebla') || lowerDescription.includes('bruma')) {
                    icon = 'üå´Ô∏è';
                    description = 'Niebla';
                } else if (lowerDescription.includes('tormenta')) {
                    icon = '‚õàÔ∏è';
                    description = 'Tormenta';
                } else if (lowerDescription.includes('calima')) {
                    icon = 'üèúÔ∏è';
                    description = 'Calima';
                }
            }
            return { icon, description };
        }

        /**
         * Funci√≥n gen√©rica para realizar llamadas a la API de AEMET (dos pasos).
         * @param {string} apiUrl - La URL inicial de la API de AEMET.
         * @returns {Promise<Object>} - Los datos JSON de la API.
         */
        async function fetchAemetData(apiUrl) {
            const maxRetries = 5;
            let retryCount = 0;

            while (retryCount < maxRetries) {
                try {
                    const response1 = await fetch(apiUrl);
                    if (!response1.ok) {
                        throw new Error(`Error HTTP en paso 1: ${response1.status} - ${response1.statusText}`);
                    }
                    const data1 = await response1.json();
                    console.log(`Respuesta inicial de AEMET para ${apiUrl}:`, data1);

                    if (!data1.datos || data1.estado !== 200) {
                        throw new Error(`Respuesta inesperada en paso 1: ${JSON.stringify(data1)}`);
                    }

                    const dataUrl = data1.datos;
                    console.log(`URL de datos real: ${dataUrl}`);

                    const response2 = await fetch(dataUrl);
                    if (!response2.ok) {
                        throw new Error(`Error HTTP en paso 2: ${response2.status} - ${response2.statusText}`);
                    }
                    const finalData = await response2.json();
                    console.log(`Datos finales de AEMET de ${dataUrl}:`, finalData);
                    return finalData;
                } catch (error) {
                    console.error('Error al obtener datos de AEMET:', error);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }

        /**
         * Obtiene y muestra los datos del clima.
         */
        async function fetchWeatherData() {
            loadingSpinner.style.display = 'block';
            errorMessageElement.classList.add('hidden');

            currentTemperatureRightElement.textContent = '--¬∞C';
            currentWeatherIconElement.textContent = '‚ùì';
            currentWeatherDescriptionElement.textContent = 'Cargando...';
            minTempElement.textContent = '--¬∞C';
            maxTempElement.textContent = '--¬∞C';
            humidityElement.textContent = '--%';
            windSpeedElement.textContent = '-- km/h';
            gustSpeedElement.textContent = '-- km/h';
            precipitationElement.textContent = '-- mm';

            try {
                const observationData = await fetchAemetData(AEMET_OBSERVATION_URL);
                let currentTemp = 'N/A';
                let humidity = 'N/A';
                let windSpeed = 'N/A';
                let gustSpeed = 'N/A';
                let precipitation = 'N/A';
                let skyStateDescriptionFromObservation = '';

                if (observationData && observationData.length > 0) {
                    const latestObservation = observationData[observationData.length - 1];
                    currentTemp = typeof latestObservation.ta !== 'undefined' ? latestObservation.ta : 'N/A';
                    humidity = typeof latestObservation.hr !== 'undefined' ? latestObservation.hr : 'N/A';
                    windSpeed = typeof latestObservation.vv !== 'undefined' ? latestObservation.vv : 'N/A';
                    gustSpeed = typeof latestObservation.vmax !== 'undefined' ? latestObservation.vmax : 'N/A';
                    precipitation = typeof latestObservation.prec !== 'undefined' ? latestObservation.prec : 'N/A';
                    skyStateDescriptionFromObservation = typeof latestObservation.estadoCielo !== 'undefined' && typeof latestObservation.estadoCielo.descripcion !== 'undefined' ? latestObservation.estadoCielo.descripcion : '';
                } else {
                    console.warn('No se recibieron datos de observaci√≥n de AEMET.');
                }

                const forecastData = await fetchAemetData(AEMET_FORECAST_URL);
                let minTemp = 'N/A';
                let maxTemp = 'N/A';
                let precipitationProb = 'N/A';
                let skyStateDescriptionFromForecast = '';

                if (forecastData && forecastData.length > 0 && forecastData[0].prediccion && forecastData[0].prediccion.dia && forecastData[0].prediccion.dia.length > 0) {
                    const todayForecast = forecastData[0].prediccion.dia[0];

                    minTemp = todayForecast.temperatura?.minima || 'N/A';
                    maxTemp = todayForecast.temperatura?.maxima || 'N/A';
                    precipitationProb = todayForecast.probPrecipitacion && todayForecast.probPrecipitacion.length > 0 ? todayForecast.probPrecipitacion[0].valor : 'N/A';
                    skyStateDescriptionFromForecast = todayForecast.estadoCielo && todayForecast.estadoCielo.length > 0 ? todayForecast.estadoCielo[0].descripcion : '';

                    if (currentTemp === 'N/A' && typeof todayForecast.temperatura?.maxima !== 'undefined' && typeof todayForecast.temperatura?.minima !== 'undefined') {
                        currentTemp = ((todayForecast.temperatura.maxima + todayForecast.temperatura.minima) / 2).toFixed(1);
                        console.warn('Temperatura actual obtenida del promedio de la predicci√≥n diaria.');
                    }
                    if (humidity === 'N/A' && todayForecast.humedadRelativa && todayForecast.humedadRelativa.length > 0) {
                        const hrPeriod = todayForecast.humedadRelativa[0];
                        if (typeof hrPeriod.minima !== 'undefined' && typeof hrPeriod.maxima !== 'undefined') {
                            humidity = ((hrPeriod.minima + hrPeriod.maxima) / 2).toFixed(0);
                            console.warn('Humedad obtenida del promedio de la predicci√≥n diaria.');
                        }
                    }
                    if (windSpeed === 'N/A' && todayForecast.viento && todayForecast.viento.length > 0) {
                        const windPeriod = todayForecast.viento[0];
                        if (typeof windPeriod.velocidad !== 'undefined') {
                            windSpeed = windPeriod.velocidad;
                            console.warn('Velocidad del viento obtenida de la predicci√≥n diaria.');
                        }
                    }
                    if (gustSpeed === 'N/A' && todayForecast.rachaMax && todayForecast.rachaMax.length > 0) {
                        const rachaMaxPeriod = todayForecast.rachaMax[0];
                        if (typeof rachaMaxPeriod.valor !== 'undefined') {
                            gustSpeed = rachaMaxPeriod.valor;
                            console.warn('Racha m√°xima obtenida de la predicci√≥n diaria.');
                        }
                    }
                    if (precipitation === 'N/A' && typeof precipitationProb !== 'undefined' && precipitationProb == 0) {
                         precipitation = 0;
                         console.warn('Precipitaci√≥n establecida a 0 mm basada en probabilidad 0% de la predicci√≥n.');
                    } else if (precipitation === 'N/A' && typeof precipitationProb !== 'undefined' && precipitationProb > 0) {
                        precipitation = 'Posible';
                        console.warn('Precipitaci√≥n marcada como "Posible" basada en la probabilidad de la predicci√≥n.');
                    }

                } else {
                    console.warn('No se recibieron datos de predicci√≥n de AEMET.');
                }

                const finalSkyStateDescription = skyStateDescriptionFromObservation !== '' ? skyStateDescriptionFromObservation : skyStateDescriptionFromForecast;

                if (windSpeed !== 'N/A' && typeof windSpeed === 'number') {
                    windSpeed = (windSpeed * 3.6).toFixed(1);
                }
                if (gustSpeed !== 'N/A' && typeof gustSpeed === 'number') {
                    gustSpeed = (gustSpeed * 3.6).toFixed(1);
                }

                currentTemperatureRightElement.textContent = `${currentTemp}¬∞C`;
                const { icon, description } = getWeatherIconAndDescription(finalSkyStateDescription);
                currentWeatherIconElement.textContent = icon;
                currentWeatherDescriptionElement.textContent = description;
                minTempElement.textContent = `${minTemp}¬∞C`;
                maxTempElement.textContent = `${maxTemp}¬∞C`;
                humidityElement.textContent = `${humidity}%`;
                precipitationElement.textContent = `${precipitation} mm`;

                windSpeedElement.textContent = `${windSpeed} km/h`;
                gustSpeedElement.textContent = `${gustSpeed} km/h`;

                loadingSpinner.style.display = 'none';

            } catch (error) {
                console.error('Error general al obtener datos del clima:', error);
                currentTemperatureRightElement.textContent = 'N/A';
                currentWeatherIconElement.textContent = '‚ùì';
                currentWeatherDescriptionElement.textContent = '';
                minTempElement.textContent = '--¬∞C';
                maxTempElement.textContent = '--¬∞C';
                humidityElement.textContent = '--%';
                windSpeedElement.textContent = '-- km/h';
                gustSpeedElement.textContent = '-- km/h';
                precipitationElement.textContent = '-- mm';
                errorMessageElement.classList.remove('hidden');
                loadingSpinner.style.display = 'none';
            }
        }

        // Llamadas iniciales al cargar la p√°gina
        updateTime();
        fetchWeatherData();

        // Actualizar la hora cada segundo
        setInterval(updateTime, 1000);

        // Actualizar los datos del clima cada 10 minutos (600000 ms)
        setInterval(fetchWeatherData, 600000);
    </script>
</body>
</html>
        <div class="lg:w-3/4 p-8 flex flex-col items-center justify-center text-center">
            <div class="flex-grow flex items-center justify-center">
                <p class="text-2xl text-gray-500">Predicci√≥n del clima por horas en Albacete</p>
            </div>

            <!-- Secci√≥n de Predicci√≥n por Horas -->
            <div id="hourly-forecast-section" class="w-full p-4 bg-gray-100 rounded-lg shadow-inner mt-auto text-left">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Pr√≥ximas 6 Horas</h2>
                <div id="hourly-forecast-content" class="flex flex-wrap justify-center gap-4">
                    <!-- La predicci√≥n por horas se cargar√° aqu√≠ -->
                    Cargando predicci√≥n horaria...
                </div>
                <div id="hourly-forecast-loading-spinner" class="loading-spinner mx-auto mt-4"></div>
                <p id="hourly-forecast-error-message" class="text-red-600 mt-4 hidden">Error al cargar la predicci√≥n por horas.</p>
            </div>
        </div>

        <!-- Contenido de la derecha (aproximadamente 1/4 del ancho): Datos consolidados -->
        <div class="lg:w-1/4 p-6 flex flex-col justify-start bg-gray-50 bg-opacity-90">

            <!-- Cuadro consolidado de informaci√≥n del clima -->
            <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center justify-center h-full">

                <!-- Albacete (Incluye hora actual, temp actual, icono, descripci√≥n y min/max temp) -->
                <div class="text-center w-full mb-4">
                    <h2 class="text-3xl lg:text-4xl font-extrabold text-gray-800 mb-2">Albacete</h2>
                    
                    <!-- Hora actual -->
                    <p id="current-time" class="text-2xl font-bold text-gray-900 mb-4 animate-pulse">Cargando...</p>

                    <div class="flex items-center justify-center mb-2">
                        <span id="current-weather-icon" class="text-5xl mr-2">‚ùì</span> <!-- Icono del tiempo -->
                        <p id="current-temperature-right" class="text-4xl font-bold text-red-500">--¬∞C</p> <!-- Temperatura actual -->
                    </div>
                    <p id="current-weather-description" class="text-lg text-gray-600 mb-4"></p> <!-- Descripci√≥n del tiempo -->

                    <!-- M√≠n. / M√°x. Temp. -->
                    <div class="text-lg text-gray-800">
                        M√≠nima: <span id="min-temp" class="font-bold text-green-700">--¬∞C</span><br>
                        M√°xima: <span id="max-temp" class="font-bold text-red-700">--¬∞C</span>
                    </div>
                </div>

                <!-- Humedad -->
                <div class="text-center w-full border-t pt-4 border-gray-200 mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">Humedad</h2>
                    <p id="humidity" class="text-3xl font-bold text-blue-700">--%</p>
                </div>

                <!-- Viento y Racha M√°xima -->
                <div class="text-center w-full border-t pt-4 border-gray-200 mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">Viento</h2>
                    <p id="wind-speed" class="text-3xl font-bold text-purple-700 mb-2">-- km/h</p>
                    <p class="text-lg text-gray-800">Racha m√°x: <span id="gust-speed" class="font-bold text-purple-700">-- km/h</span></p>
                </div>

                <!-- Precipitaci√≥n -->
                <div class="text-center w-full border-t pt-4 border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">Precipitaci√≥n</h2>
                    <p id="precipitation" class="text-3xl font-bold text-teal-700">-- mm</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Spinner de carga y mensaje de error (fuera del contenedor principal para que siempre sean visibles) -->
    <div id="loading-spinner" class="loading-spinner fixed bottom-8 right-8"></div>
    <p id="error-message" class="text-red-600 fixed bottom-4 left-1/2 -translate-x-1/2 bg-white p-2 rounded-lg shadow-lg hidden">Error al cargar los datos del clima. Por favor, verifica tu clave API de Google Maps Platform y la conexi√≥n a internet.</p>

    <script>
        // Funciones auxiliares para audio PCM (no directamente relacionadas con el clima)
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1; // Mono
            const bytesPerSample = 2; // 16-bit PCM
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;

            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(view, 8, 'WAVE');

            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bytesPerSample * 8, true);

            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);

            const combined = new Uint8Array(wavHeader.byteLength + pcmData.byteLength);
            combined.set(new Uint8Array(wavHeader), 0);
            combined.set(new Uint8Array(pcmData.buffer), wavHeader.byteLength);

            return new Blob([combined], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Referencias a los elementos del DOM
        const currentTimeElement = document.getElementById('current-time');
        const currentTemperatureRightElement = document.getElementById('current-temperature-right');
        const currentWeatherIconElement = document.getElementById('current-weather-icon');
        const currentWeatherDescriptionElement = document.getElementById('current-weather-description');
        const minTempElement = document.getElementById('min-temp');
        const maxTempElement = document.getElementById('max-temp');
        const humidityElement = document.getElementById('humidity');
        const windSpeedElement = document.getElementById('wind-speed');
        const gustSpeedElement = document.getElementById('gust-speed');
        const precipitationElement = document.getElementById('precipitation');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageElement = document.getElementById('error-message');
        const hourlyForecastContent = document.getElementById('hourly-forecast-content');
        const hourlyForecastLoadingSpinner = document.getElementById('hourly-forecast-loading-spinner');
        const hourlyForecastErrorMessage = document.getElementById('hourly-forecast-error-message');

        // Configuraci√≥n de la API de Google Maps Platform Weather
        // ¬°IMPORTANTE! Reemplaza 'TU_GOOGLE_API_KEY' con tu clave de API real de Google Maps Platform
        const GOOGLE_API_KEY = 'AIzaSyBuPf0MMxHeQtvAe-XUFdNjDAW5G0aSykE';
        const ALBACETE_LATITUDE = '38.9936';
        const ALBACETE_LONGITUDE = '-1.8568';

        const GOOGLE_CURRENT_CONDITIONS_URL = `https://weather.googleapis.com/v1/currentConditions:lookup?key=${GOOGLE_API_KEY}&location.latitude=${ALBACETE_LATITUDE}&location.longitude=${ALBACETE_LONGITUDE}`;
        const GOOGLE_HOURLY_FORECAST_URL = `https://weather.googleapis.com/v1/forecast/hours:lookup?key=${GOOGLE_API_KEY}&location.latitude=${ALBACETE_LATITUDE}&location.longitude=${ALBACETE_LONGITUDE}&pageSize=6`; // Get next 6 hours
        const GOOGLE_DAILY_FORECAST_URL = `https://weather.googleapis.com/v1/forecast/days:lookup?key=${GOOGLE_API_KEY}&location.latitude=${ALBACETE_LATITUDE}&location.longitude=${ALBACETE_LONGITUDE}&pageSize=1`; // Get today's min/max

        /**
         * Actualiza la hora actual en Albacete.
         * Utiliza Intl.DateTimeFormat para manejar la zona horaria.
         */
        function updateTime() {
            const now = new Date();
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'Europe/Madrid'
            };
            const albaceteTime = new Intl.DateTimeFormat('es-ES', options).format(now);
            currentTimeElement.textContent = albaceteTime;
        }

        /**
         * Mapea la descripci√≥n del estado del cielo de Google Weather a un icono emoji.
         * @param {string} googleDescription - Descripci√≥n del estado del cielo de la API de Google.
         * @param {boolean} isDaytime - Indica si es de d√≠a o de noche.
         * @returns {string} Icono emoji.
         */
        function getGoogleWeatherEmoji(googleDescription, isDaytime) {
            const lowerDescription = googleDescription.toLowerCase();
            if (lowerDescription.includes('sunny') || lowerDescription.includes('clear')) {
                return isDaytime ? '‚òÄÔ∏è' : 'üåô';
            } else if (lowerDescription.includes('cloudy') || lowerDescription.includes('overcast')) {
                return '‚òÅÔ∏è';
            } else if (lowerDescription.includes('partly cloudy') || lowerDescription.includes('partly sunny')) {
                return isDaytime ? '‚õÖ' : '‚òÅÔ∏è'; // Nube de noche si es parcialmente nublado
            } else if (lowerDescription.includes('rain') || lowerDescription.includes('showers') || lowerDescription.includes('drizzle')) {
                return 'üåßÔ∏è';
            } else if (lowerDescription.includes('snow')) {
                return 'üå®Ô∏è';
            } else if (lowerDescription.includes('thunderstorm')) {
                return '‚õàÔ∏è';
            } else if (lowerDescription.includes('fog') || lowerDescription.includes('mist')) {
                return 'üå´Ô∏è';
            } else {
                return '‚ùì'; // Default
            }
        }

        /**
         * Realiza una llamada a la API del clima de Google Maps Platform.
         * @param {string} url - La URL del endpoint de la API de Google Weather.
         * @returns {Promise<Object>} - Los datos JSON de la API.
         */
        async function fetchGoogleWeatherData(url) {
            const maxRetries = 5;
            let retryCount = 0;

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log(`Datos de Google Weather API de ${url}:`, data);
                    return data;
                } catch (error) {
                    console.error('Error al obtener datos de Google Weather API:', error);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }

        /**
         * Obtiene y muestra los datos del clima actual y el pron√≥stico diario y horario.
         */
        async function fetchWeatherData() {
            loadingSpinner.style.display = 'block';
            errorMessageElement.classList.add('hidden');
            hourlyForecastLoadingSpinner.style.display = 'block';
            hourlyForecastErrorMessage.classList.add('hidden');

            // Resetear textos de datos
            currentTemperatureRightElement.textContent = '--¬∞C';
            currentWeatherIconElement.textContent = '‚ùì';
            currentWeatherDescriptionElement.textContent = 'Cargando...';
            minTempElement.textContent = '--¬∞C';
            maxTempElement.textContent = '--¬∞C';
            humidityElement.textContent = '--%';
            windSpeedElement.textContent = '-- km/h';
            gustSpeedElement.textContent = '-- km/h';
            precipitationElement.textContent = '-- mm';
            hourlyForecastContent.innerHTML = 'Cargando predicci√≥n horaria...';

            try {
                const currentDataPromise = fetchGoogleWeatherData(GOOGLE_CURRENT_CONDITIONS_URL);
                const hourlyForecastPromise = fetchGoogleWeatherData(GOOGLE_HOURLY_FORECAST_URL);
                const dailyForecastPromise = fetchGoogleWeatherData(GOOGLE_DAILY_FORECAST_URL);

                const [currentData, hourlyForecasts, dailyForecasts] = await Promise.all([
                    currentDataPromise,
                    hourlyForecastPromise,
                    dailyForecastPromise
                ]);

                // --- Procesar datos actuales ---
                const currentTemp = currentData.temperature?.value || 'N/A';
                const humidity = currentData.humidity?.value || 'N/A';
                const windSpeedMps = currentData.wind?.speed?.value || 'N/A'; // m/s
                const gustSpeedMps = currentData.wind?.gust?.value || 'N/A'; // m/s
                const precipitationMm = currentData.precipitation?.value || 0; // mm
                const weatherDescription = currentData.weatherCondition?.description || 'Desconocido';
                const isDaytime = currentData.isDaytime;

                // --- Procesar datos diarios (min/max) ---
                let minTemp = 'N/A';
                let maxTemp = 'N/A';
                if (dailyForecasts && dailyForecasts.forecastDays && dailyForecasts.forecastDays.length > 0) {
                    const todayDailyForecast = dailyForecasts.forecastDays[0];
                    minTemp = todayDailyForecast.temperature?.min?.value || 'N/A';
                    maxTemp = todayDailyForecast.temperature?.max?.value || 'N/A';
                }

                // Conversi√≥n de m/s a km/h
                const windSpeedKmh = typeof windSpeedMps === 'number' ? (windSpeedMps * 3.6).toFixed(1) : 'N/A';
                const gustSpeedKmh = typeof gustSpeedMps === 'number' ? (gustSpeedMps * 3.6).toFixed(1) : 'N/A';

                // Actualizar elementos del DOM (datos actuales y diarios)
                currentTemperatureRightElement.textContent = `${currentTemp}¬∞C`;
                currentWeatherIconElement.textContent = getGoogleWeatherEmoji(weatherDescription, isDaytime);
                currentWeatherDescriptionElement.textContent = weatherDescription;
                minTempElement.textContent = `${minTemp}¬∞C`;
                maxTempElement.textContent = `${maxTemp}¬∞C`;
                humidityElement.textContent = `${humidity}%`;
                windSpeedElement.textContent = `${windSpeedKmh} km/h`;
                gustSpeedElement.textContent = `${gustSpeedKmh} km/h`;
                precipitationElement.textContent = `${precipitationMm} mm`;

                // --- Procesar pron√≥stico por horas ---
                let hourlyHtml = '';
                const forecastHours = hourlyForecasts.forecastHours || [];

                if (forecastHours.length > 0) {
                    forecastHours.forEach(hourData => {
                        const hour = new Date(hourData.interval.startTime).getHours().toString().padStart(2, '0');
                        const temp = hourData.temperature?.value || '--';
                        const precip = hourData.precipitation?.value || 0; // mm
                        const windMps = hourData.wind?.speed?.value || '--'; // m/s
                        const windKmh = typeof windMps === 'number' ? (windMps * 3.6).toFixed(0) : '--';
                        const hourlyWeatherDesc = hourData.weatherCondition?.description || 'Desconocido';
                        const hourlyIsDaytime = hourData.isDaytime;
                        const icon = getGoogleWeatherEmoji(hourlyWeatherDesc, hourlyIsDaytime);

                        hourlyHtml += `
                            <div class="flex flex-col items-center p-2 bg-white rounded-lg shadow-sm w-24">
                                <span class="text-sm font-semibold text-gray-700">${hour}:00h</span>
                                <span class="text-3xl my-1">${icon}</span>
                                <span class="text-lg font-bold text-gray-800">${temp}¬∞C</span>
                                <span class="text-sm text-gray-600">üíß ${precip}mm</span>
                                <span class="text-sm text-gray-600">üí® ${windKmh} km/h</span>
                            </div>
                        `;
                    });
                    hourlyForecastContent.innerHTML = hourlyHtml;
                    hourlyForecastErrorMessage.classList.add('hidden');
                } else {
                    hourlyForecastContent.innerHTML = 'No hay datos de predicci√≥n por horas disponibles.';
                    hourlyForecastErrorMessage.classList.remove('hidden');
                    hourlyForecastErrorMessage.textContent = 'No se pudo cargar la predicci√≥n por horas.';
                }

            } catch (error) {
                console.error('Error general al obtener datos del clima:', error);
                // Mostrar mensajes de error y resetear UI
                currentTemperatureRightElement.textContent = 'N/A';
                currentWeatherIconElement.textContent = '‚ùì';
                currentWeatherDescriptionElement.textContent = 'Error';
                minTempElement.textContent = '--¬∞C';
                maxTempElement.textContent = '--¬∞C';
                humidityElement.textContent = '--%';
                windSpeedElement.textContent = '-- km/h';
                gustSpeedElement.textContent = '-- km/h';
                precipitationElement.textContent = '-- mm';
                hourlyForecastContent.innerHTML = 'Error al cargar la predicci√≥n por horas.';
                errorMessageElement.classList.remove('hidden');
                hourlyForecastErrorMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.style.display = 'none';
                hourlyForecastLoadingSpinner.style.display = 'none';
            }
        }

        // Llamadas iniciales al cargar la p√°gina
        updateTime();
        fetchWeatherData();

        // Actualizar la hora cada segundo
        setInterval(updateTime, 1000);

        // Actualizar los datos del clima cada 10 minutos (600000 ms)
        setInterval(fetchWeatherData, 600000);
    </script>
</body>
</html>
