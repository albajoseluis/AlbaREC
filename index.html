<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clima Detallado de Albacete</title>
    <!-- Carga de Tailwind CSS para un dise√±o responsivo y r√°pido -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Chart.js para los gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos personalizados para el fondo verde croma */
        body {
            background-color: #00FF00; /* Verde croma */
            font-family: 'Inter', sans-serif; /* Fuente Inter */
        }
        /* Ocultar el spinner de carga por defecto */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: none; /* Oculto por defecto */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Asegura que los elementos canvas sean responsivos dentro de sus contenedores */
        canvas {
            max-width: 100%;
            height: auto; /* Permite que la altura se ajuste seg√∫n la relaci√≥n de aspecto */
        }
        /* Animaci√≥n de desplazamiento para el resumen del clima */
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            animation: marquee 30s linear infinite; /* Duraci√≥n y repetici√≥n del desplazamiento */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor principal para la sensaci√≥n de 16:9 y el dise√±o -->
    <!-- h-[calc(100vh-2rem)] asegura que ocupe casi toda la altura de la ventana, dejando un margen -->
    <div class="flex flex-col lg:flex-row w-full max-w-screen-xl h-[calc(100vh-2rem)] bg-white bg-opacity-90 rounded-lg shadow-xl overflow-hidden">

        <!-- Contenido de la izquierda (aproximadamente 3/4 del ancho) -->
        <div class="lg:w-3/4 p-8 flex flex-col items-center justify-center text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 mb-6">Albacete</h1>

            <!-- Secci√≥n de Hora Actual -->
            <div class="mb-8 p-4 bg-gray-100 rounded-lg shadow-inner w-full">
                <p class="text-gray-600 text-lg mb-2">Hora actual:</p>
                <p id="current-time" class="text-6xl md:text-7xl font-bold text-blue-600 animate-pulse">Cargando...</p>
            </div>

            <!-- Secci√≥n de Temperatura Actual (principal en la izquierda) -->
            <div class="p-4 bg-gray-100 rounded-lg shadow-inner w-full mb-8">
                <p class="text-gray-600 text-lg mb-2">Temperatura actual:</p>
                <p id="current-temperature" class="text-5xl md:text-6xl font-bold text-red-500">Cargando...</p>
            </div>

            <!-- Secci√≥n para el resumen del clima generado por la IA en una barra deslizante -->
            <div class="w-full p-4 bg-gray-100 rounded-lg shadow-inner mt-auto overflow-hidden relative h-20 flex items-center">
                <div id="weather-summary-content" class="text-gray-800 text-base absolute left-0 whitespace-nowrap">
                    <!-- El resumen del clima se cargar√° y se desplazar√° aqu√≠ -->
                </div>
                <div id="summary-loading-spinner" class="loading-spinner mx-auto"></div>
            </div>
        </div>

        <!-- Contenido de la derecha (aproximadamente 1/4 del ancho): Datos y Gr√°ficos -->
        <div class="lg:w-1/4 p-6 flex flex-col justify-between space-y-4 bg-gray-50 bg-opacity-90">

            <!-- Nuevo: Temperatura Actual con Icono en el panel derecho -->
            <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center justify-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Clima Actual</h2>
                <div class="flex items-center justify-center mb-2">
                    <span id="current-weather-icon" class="text-5xl mr-2">‚ùì</span> <!-- Icono del tiempo -->
                    <p id="current-temperature-right" class="text-4xl font-bold text-red-500">--¬∞C</p> <!-- Temperatura actual -->
                </div>
                <p id="current-weather-description" class="text-lg text-gray-600">Cargando...</p>
            </div>

            <!-- Temperatura M√≠nima y M√°xima (sin gr√°fico debajo) -->
            <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center justify-center flex-grow">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">M√≠n. / M√°x. Temp. (Hoy)</h2>
                <div class="text-lg text-gray-800 mb-2">
                    M√≠nima: <span id="min-temp" class="font-bold text-green-700">--¬∞C</span><br>
                    M√°xima: <span id="max-temp" class="font-bold text-red-700">--¬∞C</span>
                </div>
            </div>

            <!-- Humedad -->
            <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center justify-center flex-grow">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Humedad</h2>
                <p id="humidity" class="text-3xl font-bold text-blue-700 mb-2">--%</p>
                <canvas id="humidityChart" class="w-full"></canvas>
            </div>

            <!-- Viento -->
            <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center justify-center flex-grow">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Viento</h2>
                <p id="wind-speed" class="text-3xl font-bold text-purple-700 mb-2">-- m/s</p>
                <canvas id="windChart" class="w-full"></canvas>
            </div>

            <!-- Probabilidad de Precipitaci√≥n -->
            <div class="p-4 bg-white rounded-lg shadow-md flex flex-col items-center justify-center flex-grow">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Prob. Precipitaci√≥n (Hoy)</h2>
                <p id="precipitation" class="text-3xl font-bold text-teal-700 mb-2">--%</p>
                <canvas id="precipitationChart" class="w-full"></canvas>
            </div>
        </div>
    </div>

    <!-- Spinner de carga y mensaje de error (fuera del contenedor principal para que siempre sean visibles) -->
    <div id="loading-spinner" class="loading-spinner fixed bottom-8 right-8"></div>
    <p id="error-message" class="text-red-600 fixed bottom-4 left-1/2 -translate-x-1/2 bg-white p-2 rounded-lg shadow-lg hidden">Error al cargar los datos del clima. Por favor, verifica tu clave API de AEMET y la conexi√≥n a internet.</p>

    <script>
        // Funciones auxiliares para audio PCM (no directamente relacionadas con el clima, pero mantenidas del c√≥digo anterior)
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1; // Mono
            const bytesPerSample = 2; // 16-bit PCM
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;

            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(view, 8, 'WAVE');

            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bytesPerSample * 8, true);

            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);

            const combined = new Uint8Array(wavHeader.byteLength + pcmData.byteLength);
            combined.set(new Uint8Array(wavHeader), 0);
            combined.set(new Uint8Array(pcmData.buffer), wavHeader.byteLength);

            return new Blob([combined], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Referencias a los elementos del DOM
        const currentTimeElement = document.getElementById('current-time');
        const currentTemperatureElement = document.getElementById('current-temperature'); // Temperatura principal (izquierda)
        const currentTemperatureRightElement = document.getElementById('current-temperature-right'); // Temperatura en panel derecho
        const currentWeatherIconElement = document.getElementById('current-weather-icon'); // Icono del tiempo
        const currentWeatherDescriptionElement = document.getElementById('current-weather-description'); // Descripci√≥n del tiempo
        const minTempElement = document.getElementById('min-temp');
        const maxTempElement = document.getElementById('max-temp');
        const humidityElement = document.getElementById('humidity');
        const windSpeedElement = document.getElementById('wind-speed');
        const precipitationElement = document.getElementById('precipitation');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageElement = document.getElementById('error-message');
        const weatherSummaryContent = document.getElementById('weather-summary-content');
        const summaryLoadingSpinner = document.getElementById('summary-loading-spinner');


        // Configuraci√≥n de la API de AEMET
        const AEMET_API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJlbG1pcmFkb3JkZWFsYmFjZXRlQGdtYWlsLmNvbSIsImp0aSI6IjVkOWEwODRkLWIyMGYtNDVhNy1iNGIwLTNkYjExNjAwYjhlZCIsImlzcyI6IkFFTUVUIiwiaWF0IjoxNzU0MDg1MTU3LCJ1c2VySWQiOiI1ZDlhMDg0ZC1iMjBmLTQ1YTctYjRiMC0zZGIxMTYwMGI4ZWQiLCJyb2xlIjoiIn0.-6ok6kl3fvxe_OZt8Unq_WDZ7OjXBHLJGwx-O8FUXuM';
        const ALBACETE_STATION_ID = '8178D'; // ID de la estaci√≥n de Albacete (Observatorio)
        const ALBACETE_MUNICIPALITY_CODE = '02003'; // C√≥digo de municipio de Albacete

        // URLs de la API de AEMET
        const AEMET_OBSERVATION_URL = `https://opendata.aemet.es/opendata/api/observacion/convencional/datos/estacion/${ALBACETE_STATION_ID}?api_key=${AEMET_API_KEY}`;
        const AEMET_FORECAST_URL = `https://opendata.aemet.es/opendata/api/prediccion/especifica/municipio/diaria/${ALBACETE_MUNICIPALITY_CODE}?api_key=${AEMET_API_KEY}`;

        // Variables para almacenar instancias de gr√°ficos
        let humidityChartInstance;
        let windChartInstance;
        let precipitationChartInstance;

        /**
         * Actualiza la hora actual en Albacete.
         * Utiliza Intl.DateTimeFormat para manejar la zona horaria.
         */
        function updateTime() {
            const now = new Date();
            // Formatear la hora para la zona horaria de Madrid (que incluye Albacete)
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Europe/Madrid'
            };
            const albaceteTime = new Intl.DateTimeFormat('es-ES', options).format(now);
            currentTimeElement.textContent = albaceteTime;
        }

        /**
         * Mapea la descripci√≥n del estado del cielo de AEMET a un icono emoji y una descripci√≥n amigable.
         * @param {string} aemetDescription - Descripci√≥n del estado del cielo de la API de AEMET.
         * @returns {{icon: string, description: string}} Objeto con el icono emoji y la descripci√≥n.
         */
        function getWeatherIconAndDescription(aemetDescription) {
            let icon = '‚ùì'; // Icono por defecto (signo de interrogaci√≥n)
            let description = aemetDescription || 'Desconocido'; // Descripci√≥n por defecto

            if (aemetDescription) {
                if (aemetDescription.includes('Despejado') || aemetDescription.includes('Soleado')) {
                    icon = '‚òÄÔ∏è';
                    description = 'Soleado';
                } else if (aemetDescription.includes('Poco nuboso') || aemetDescription.includes('Intervalos nubosos')) {
                    icon = '‚õÖ';
                    description = 'Parcialmente Nublado';
                } else if (aemetDescription.includes('Nuboso') || aemetDescription.includes('Cubierto')) {
                    icon = '‚òÅÔ∏è';
                    description = 'Nublado';
                } else if (aemetDescription.includes('Lluvia') || aemetDescription.includes('Chubascos')) {
                    icon = 'üåßÔ∏è';
                    description = 'Lluvioso';
                } else if (aemetDescription.includes('Nieve')) {
                    icon = 'üå®Ô∏è';
                    description = 'Nevando';
                } else if (aemetDescription.includes('Niebla')) {
                    icon = 'üå´Ô∏è';
                    description = 'Niebla';
                } else if (aemetDescription.includes('Tormenta')) {
                    icon = '‚õàÔ∏è';
                    description = 'Tormenta';
                }
                // Se pueden a√±adir m√°s condiciones seg√∫n sea necesario
            }
            return { icon, description };
        }

        /**
         * Dibuja el gr√°fico de humedad.
         * @param {number} humidityVal - Valor de la humedad.
         */
        function drawHumidityChart(humidityVal) {
            const ctx = document.getElementById('humidityChart').getContext('2d');
            if (humidityChartInstance) {
                humidityChartInstance.destroy();
            }
            humidityChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Humedad', 'Restante'],
                    datasets: [{
                        data: [humidityVal, 100 - humidityVal],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)', // Azul para humedad
                            'rgba(209, 213, 219, 0.7)' // Gris claro para el resto
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(209, 213, 219, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Dibuja el gr√°fico de velocidad del viento.
         * @param {number} windSpeedVal - Velocidad del viento.
         */
        function drawWindChart(windSpeedVal) {
            const ctx = document.getElementById('windChart').getContext('2d');
            if (windChartInstance) {
                windChartInstance.destroy();
            }
            windChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Viento'],
                    datasets: [{
                        label: 'Velocidad (m/s)',
                        data: [windSpeedVal],
                        backgroundColor: 'rgba(168, 85, 247, 0.7)', // P√∫rpura
                        borderColor: 'rgba(168, 85, 247, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 20, // Ajustar seg√∫n la velocidad m√°xima esperada
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#4A5568'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#4A5568'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }

        /**
         * Dibuja el gr√°fico de probabilidad de precipitaci√≥n.
         * @param {number} precipitationProb - Probabilidad de precipitaci√≥n en porcentaje.
         */
        function drawPrecipitationChart(precipitationProb) {
            const ctx = document.getElementById('precipitationChart').getContext('2d');
            if (precipitationChartInstance) {
                precipitationChartInstance.destroy();
            }
            precipitationChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Probabilidad'],
                    datasets: [{
                        label: 'Probabilidad (%)',
                        data: [precipitationProb],
                        backgroundColor: 'rgba(20, 184, 166, 0.7)', // Verde azulado oscuro
                        borderColor: 'rgba(20, 184, 166, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100, // La probabilidad va de 0 a 100%
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#4A5568'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#4A5568'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }

        /**
         * Funci√≥n gen√©rica para realizar llamadas a la API de AEMET (dos pasos).
         * @param {string} apiUrl - La URL inicial de la API de AEMET.
         * @returns {Promise<Object>} - Los datos JSON de la API.
         */
        async function fetchAemetData(apiUrl) {
            const maxRetries = 5;
            let retryCount = 0;

            while (retryCount < maxRetries) {
                try {
                    // Paso 1: Obtener la URL de los datos
                    const response1 = await fetch(apiUrl);
                    if (!response1.ok) {
                        throw new Error(`Error HTTP en paso 1: ${response1.status} - ${response1.statusText}`);
                    }
                    const data1 = await response1.json();
                    console.log(`Respuesta inicial de AEMET para ${apiUrl}:`, data1); // Depuraci√≥n

                    if (!data1.datos || data1.estado !== 200) { // Comprobar estado expl√≠citamente
                        throw new Error(`Respuesta inesperada en paso 1: ${JSON.stringify(data1)}`);
                    }

                    const dataUrl = data1.datos; // URL real de los datos
                    console.log(`URL de datos real: ${dataUrl}`); // Depuraci√≥n

                    // Paso 2: Obtener los datos de la URL proporcionada
                    const response2 = await fetch(dataUrl);
                    if (!response2.ok) {
                        throw new Error(`Error HTTP en paso 2: ${response2.status} - ${response2.statusText}`);
                    }
                    const finalData = await response2.json();
                    console.log(`Datos finales de AEMET de ${dataUrl}:`, finalData); // Depuraci√≥n
                    return finalData; // Retorna los datos finales
                } catch (error) {
                    console.error('Error al obtener datos de AEMET:', error);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error; // Relanza el error si fallan todos los reintentos
                    }
                }
            }
        }

        /**
         * Realiza una llamada a la API del clima para obtener los datos completos.
         * Muestra un spinner de carga y maneja posibles errores.
         */
        async function fetchWeatherData() {
            loadingSpinner.style.display = 'block'; // Mostrar spinner
            errorMessageElement.classList.add('hidden'); // Ocultar mensaje de error
            // Resetear textos de datos
            currentTemperatureElement.textContent = 'Cargando...';
            currentTemperatureRightElement.textContent = '--¬∞C';
            currentWeatherIconElement.textContent = '‚ùì';
            currentWeatherDescriptionElement.textContent = 'Cargando...';
            minTempElement.textContent = '--¬∞C';
            maxTempElement.textContent = '--¬∞C';
            humidityElement.textContent = '--%';
            windSpeedElement.textContent = '-- m/s';
            precipitationElement.textContent = '--%'; // Ahora es porcentaje

            try {
                // Obtener datos de observaci√≥n actual
                const observationData = await fetchAemetData(AEMET_OBSERVATION_URL);
                let currentTemp = 'N/A';
                let humidity = 'N/A';
                let windSpeed = 'N/A';
                let skyStateDescriptionFromObservation = 'N/A'; // Puede que la observaci√≥n tenga una descripci√≥n del cielo

                // La API de observaci√≥n devuelve un array, tomamos la √∫ltima observaci√≥n
                if (observationData && observationData.length > 0) {
                    const latestObservation = observationData[observationData.length - 1]; // √öltima observaci√≥n
                    console.log('√öltima observaci√≥n de AEMET (detalle):', latestObservation); // Depuraci√≥n

                    // Extraer temperatura
                    if (typeof latestObservation.ta !== 'undefined') { // Usamos 'ta' para temperatura del aire
                        currentTemp = latestObservation.ta;
                    } else {
                        console.warn('Temperatura (ta) no encontrada en la √∫ltima observaci√≥n de AEMET. Intentando con predicci√≥n.');
                    }

                    // Extraer humedad
                    if (typeof latestObservation.hr !== 'undefined') { // Usamos 'hr' para humedad relativa
                        humidity = latestObservation.hr;
                    } else {
                        console.warn('Humedad (hr) no encontrada en la √∫ltima observaci√≥n de AEMET. Intentando con predicci√≥n.');
                    }

                    // Extraer velocidad del viento
                    if (typeof latestObservation.vv !== 'undefined') { // Usamos 'vv' para velocidad del viento
                        windSpeed = latestObservation.vv;
                    } else {
                        console.warn('Velocidad del viento (vv) no encontrada en la √∫ltima observaci√≥n de AEMET. Intentando con predicci√≥n.');
                    }

                    // Intentar obtener la descripci√≥n del cielo de la observaci√≥n si est√° disponible
                    if (typeof latestObservation.estadoCielo !== 'undefined' && typeof latestObservation.estadoCielo.descripcion !== 'undefined') {
                        skyStateDescriptionFromObservation = latestObservation.estadoCielo.descripcion;
                    }
                } else {
                    console.warn('No se recibieron datos de observaci√≥n de AEMET.');
                }

                // Obtener datos de predicci√≥n diaria
                const forecastData = await fetchAemetData(AEMET_FORECAST_URL);
                let minTemp = 'N/A';
                let maxTemp = 'N/A';
                let precipitationProb = 'N/A';
                let skyStateDescriptionFromForecast = 'N/A';

                if (forecastData && forecastData.length > 0 && forecastData[0].prediccion && forecastData[0].prediccion.dia && forecastData[0].prediccion.dia.length > 0) {
                    const todayForecast = forecastData[0].prediccion.dia[0]; // Predicci√≥n para hoy
                    console.log('Predicci√≥n de AEMET para hoy (detalle):', todayForecast); // Depuraci√≥n

                    minTemp = todayForecast.temperatura?.minima || 'N/A';
                    maxTemp = todayForecast.temperatura?.maxima || 'N/A';
                    // La precipitaci√≥n es un array de objetos por periodos, tomamos el valor del primer periodo (ej. 00-24)
                    precipitationProb = todayForecast.probPrecipitacion && todayForecast.probPrecipitacion.length > 0 ? todayForecast.probPrecipitacion[0].valor : 'N/A';
                    // Estado del cielo, tomamos la descripci√≥n del primer periodo del d√≠a
                    skyStateDescriptionFromForecast = todayForecast.estadoCielo && todayForecast.estadoCielo.length > 0 ? todayForecast.estadoCielo[0].descripcion : 'N/A';

                    // Fallback para currentTemp, humidity, windSpeed si no se encontraron en la observaci√≥n
                    if (currentTemp === 'N/A' && typeof todayForecast.temperatura?.maxima !== 'undefined' && typeof todayForecast.temperatura?.minima !== 'undefined') {
                        currentTemp = ((todayForecast.temperatura.maxima + todayForecast.temperatura.minima) / 2).toFixed(1); // Usar promedio de min/max
                        console.warn('Temperatura actual obtenida del promedio de la predicci√≥n diaria.');
                    }
                    if (humidity === 'N/A' && todayForecast.humedadRelativa && todayForecast.humedadRelativa.length > 0) {
                        // AEMET forecast humidity tiene min/max para periodos, tomamos el promedio del primer periodo
                        const hrPeriod = todayForecast.humedadRelativa[0];
                        if (typeof hrPeriod.minima !== 'undefined' && typeof hrPeriod.maxima !== 'undefined') {
                            humidity = ((hrPeriod.minima + hrPeriod.maxima) / 2).toFixed(0);
                            console.warn('Humedad obtenida del promedio de la predicci√≥n diaria.');
                        }
                    }
                    if (windSpeed === 'N/A' && todayForecast.viento && todayForecast.viento.length > 0) {
                        // AEMET forecast wind tiene velocidad para periodos, tomamos la velocidad del primer periodo
                        const windPeriod = todayForecast.viento[0];
                        if (typeof windPeriod.velocidad !== 'undefined') {
                            windSpeed = windPeriod.velocidad;
                            console.warn('Velocidad del viento obtenida de la predicci√≥n diaria.');
                        }
                    }

                } else {
                    console.warn('No se recibieron datos de predicci√≥n de AEMET.');
                }

                // Usar la descripci√≥n del cielo de la observaci√≥n si est√° disponible, si no, la de la predicci√≥n
                const finalSkyStateDescription = skyStateDescriptionFromObservation !== 'N/A' ? skyStateDescriptionFromObservation : skyStateDescriptionFromForecast;


                // Actualizar elementos del DOM
                currentTemperatureElement.textContent = `${currentTemp}¬∞C`; // Principal (izquierda)
                currentTemperatureRightElement.textContent = `${currentTemp}¬∞C`; // En panel derecho
                const { icon, description } = getWeatherIconAndDescription(finalSkyStateDescription);
                currentWeatherIconElement.textContent = icon;
                currentWeatherDescriptionElement.textContent = description;
                minTempElement.textContent = `${minTemp}¬∞C`;
                maxTempElement.textContent = `${maxTemp}¬∞C`;
                humidityElement.textContent = `${humidity}%`;
                windSpeedElement.textContent = `${windSpeed} m/s`;
                precipitationElement.textContent = `${precipitationProb}%`;

                // Dibujar gr√°ficos (asegurarse de que los valores sean n√∫meros para los gr√°ficos)
                drawHumidityChart(parseFloat(humidity) || 0);
                drawWindChart(parseFloat(windSpeed) || 0);
                drawPrecipitationChart(parseFloat(precipitationProb) || 0);

                loadingSpinner.style.display = 'none'; // Ocultar spinner

                // Generar el resumen del clima autom√°ticamente despu√©s de cargar los datos
                generateWeatherSummary();

            } catch (error) {
                console.error('Error general al obtener datos del clima:', error);
                // Mostrar mensaje de error y ocultar spinner
                currentTemperatureElement.textContent = 'No disponible';
                currentTemperatureRightElement.textContent = 'N/A';
                currentWeatherIconElement.textContent = '‚ùì';
                currentWeatherDescriptionElement.textContent = 'Error';
                minTempElement.textContent = '--¬∞C';
                maxTempElement.textContent = '--¬∞C';
                humidityElement.textContent = '--%';
                windSpeedElement.textContent = '-- m/s';
                precipitationElement.textContent = '--%';
                errorMessageElement.classList.remove('hidden');
                loadingSpinner.style.display = 'none';
            }
        }

        /**
         * Genera un resumen del clima utilizando la API de Gemini.
         */
        async function generateWeatherSummary() {
            weatherSummaryContent.textContent = ''; // Limpiar contenido previo
            summaryLoadingSpinner.style.display = 'block'; // Mostrar spinner de carga del resumen
            weatherSummaryContent.classList.remove('animate-marquee'); // Detener animaci√≥n mientras carga

            const currentTemp = currentTemperatureElement.textContent;
            const minTemp = minTempElement.textContent;
            const maxTemp = maxTempElement.textContent;
            const humidity = humidityElement.textContent;
            const windSpeed = windSpeedElement.textContent;
            const precipitationProb = precipitationElement.textContent;
            const weatherDescription = currentWeatherDescriptionElement.textContent; // Nueva descripci√≥n del clima

            const prompt = `Genera un resumen conciso y amigable del clima actual en Albacete, Espa√±a, bas√°ndote en los siguientes datos:
            - Estado del cielo: ${weatherDescription}
            - Temperatura actual: ${currentTemp}
            - Temperatura m√≠nima (hoy): ${minTemp}
            - Temperatura m√°xima (hoy): ${maxTemp}
            - Humedad: ${humidity}
            - Velocidad del viento: ${windSpeed}
            - Probabilidad de precipitaci√≥n (hoy): ${precipitationProb}

            Por favor, enf√≥cate en los puntos clave y hazlo f√°cil de entender para cualquier persona. No incluyas la hora actual.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // La clave API se proporciona autom√°ticamente en el entorno de Canvas si est√° vac√≠a
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    weatherSummaryContent.textContent = text;
                    weatherSummaryContent.classList.add('animate-marquee'); // Iniciar animaci√≥n
                } else {
                    weatherSummaryContent.textContent = 'No se pudo generar el resumen del clima. Int√©ntalo de nuevo.';
                }
            } catch (error) {
                weatherSummaryContent.textContent = 'Error al conectar con la IA para generar el resumen.';
                console.error('Error al llamar a la API de Gemini:', error);
            } finally {
                summaryLoadingSpinner.style.display = 'none'; // Ocultar spinner del resumen
            }
        }

        // Llamadas iniciales al cargar la p√°gina
        updateTime(); // Actualizar la hora inmediatamente
        fetchWeatherData(); // Obtener los datos del clima inmediatamente

        // Actualizar la hora cada segundo
        setInterval(updateTime, 1000);

        // Actualizar los datos del clima cada 10 minutos (600000 ms)
        setInterval(fetchWeatherData, 600000);
    </script>
</body>
</html>
